<Window x:Class="slsk_batchdl.Gui.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:vm="clr-namespace:slsk_batchdl.Gui.ViewModels"
        xmlns:converters="clr-namespace:slsk_batchdl.Gui.Converters"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance vm:MainViewModel}"
        Title="sldl"
        Icon="Resources/app.ico"
        Height="650" Width="950"
        MinHeight="450" MinWidth="700"
        Style="{StaticResource MaterialDesignWindow}"
        Background="{DynamicResource MaterialDesign.Brush.Background}"
        TextElement.Foreground="{DynamicResource MaterialDesign.Brush.Foreground}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="14"
        FontFamily="{materialDesign:MaterialDesignFont}">

    <Window.TaskbarItemInfo>
        <TaskbarItemInfo
            ProgressValue="{Binding TaskbarProgress}"
            ProgressState="{Binding TaskbarProgressState}" />
    </Window.TaskbarItemInfo>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        <converters:ZeroToVisibleConverter x:Key="ZeroToVisibleConverter" />
        <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Row 0: Search Input -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBox
                Grid.Column="0"
                Text="{Binding SearchInput, UpdateSourceTrigger=PropertyChanged}"
                materialDesign:HintAssist.Hint="Spotify/YouTube URL or search query..."
                materialDesign:HintAssist.IsFloating="False"
                materialDesign:TextFieldAssist.HasClearButton="True"
                Style="{StaticResource MaterialDesignOutlinedTextBox}"
                FontSize="16"
                Margin="0,0,12,0"
                VerticalContentAlignment="Center">
                <TextBox.InputBindings>
                    <KeyBinding Key="Return" Command="{Binding StartDownloadCommand}" />
                </TextBox.InputBindings>
            </TextBox>

            <!-- Start button (visible when not downloading) -->
            <Button
                Grid.Column="1"
                Command="{Binding StartDownloadCommand}"
                Style="{StaticResource MaterialDesignRaisedButton}"
                Height="48" Width="120"
                FontSize="15"
                Visibility="{Binding IsDownloading, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Play" VerticalAlignment="Center" Margin="0,0,6,0" />
                    <TextBlock Text="Start" VerticalAlignment="Center" />
                </StackPanel>
            </Button>

            <!-- Stop button (visible when downloading) -->
            <Button
                Grid.Column="1"
                Command="{Binding StopDownloadCommand}"
                Style="{StaticResource MaterialDesignRaisedButton}"
                Height="48" Width="120"
                FontSize="15"
                Visibility="{Binding IsDownloading, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Stop" VerticalAlignment="Center" Margin="0,0,6,0" />
                    <TextBlock Text="Stop" VerticalAlignment="Center" />
                </StackPanel>
            </Button>

            <Button
                Grid.Column="2"
                x:Name="SettingsButton"
                Click="SettingsButton_Click"
                Style="{StaticResource MaterialDesignIconButton}"
                ToolTip="Settings"
                Height="48" Width="48"
                Margin="4,0,0,0">
                <materialDesign:PackIcon Kind="Cog" Width="24" Height="24" />
            </Button>
        </Grid>

        <!-- Row 1: Quick Settings -->
        <materialDesign:Card Grid.Row="1" Margin="0,0,0,16" Padding="16"
                             materialDesign:ElevationAssist.Elevation="Dp1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Format -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,24,0">
                    <materialDesign:PackIcon Kind="MusicNote" VerticalAlignment="Center"
                                             Margin="0,0,8,0" Opacity="0.6" />
                    <ComboBox
                        ItemsSource="{Binding AvailableFormats}"
                        SelectedItem="{Binding SelectedFormat}"
                        materialDesign:HintAssist.Hint="Format"
                        materialDesign:HintAssist.IsFloating="True"
                        Style="{StaticResource MaterialDesignOutlinedComboBox}"
                        Width="100" />
                </StackPanel>

                <!-- Bitrate -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="0,0,24,0">
                    <materialDesign:PackIcon Kind="Equalizer" VerticalAlignment="Center"
                                             Margin="0,0,8,0" Opacity="0.6" />
                    <ComboBox
                        ItemsSource="{Binding AvailableBitrates}"
                        SelectedItem="{Binding PreferredBitrate}"
                        materialDesign:HintAssist.Hint="Min kbps"
                        materialDesign:HintAssist.IsFloating="True"
                        Style="{StaticResource MaterialDesignOutlinedComboBox}"
                        Width="100" />
                </StackPanel>

                <!-- Download Path -->
                <TextBox
                    Grid.Column="2"
                    Text="{Binding DownloadPath, UpdateSourceTrigger=PropertyChanged}"
                    materialDesign:HintAssist.Hint="Download path"
                    materialDesign:HintAssist.IsFloating="True"
                    Style="{StaticResource MaterialDesignOutlinedTextBox}"
                    VerticalContentAlignment="Center"
                    Margin="0,0,8,0" />

                <Button
                    Grid.Column="3"
                    Command="{Binding BrowseDownloadPathCommand}"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    Padding="8" Height="40">
                    <materialDesign:PackIcon Kind="FolderOpen" />
                </Button>
            </Grid>
        </materialDesign:Card>

        <!-- Row 2: Download List -->
        <materialDesign:Card Grid.Row="2" Margin="0,0,0,12"
                             materialDesign:ElevationAssist.Elevation="Dp1">
            <Grid ClipToBounds="True">
                <!-- Background watermark -->
                <Image Source="Resources/dog.png"
                       Width="200" Height="200"
                       Stretch="UniformToFill"
                       Opacity="0.5"
                       IsHitTestVisible="False"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       RenderTransformOrigin="0.5,1">
                    <Image.RenderTransform>
                        <TransformGroup>
                            <TranslateTransform x:Name="DogTranslate" />
                            <ScaleTransform x:Name="DogScale" ScaleX="1" ScaleY="1" />
                        </TransformGroup>
                    </Image.RenderTransform>
                    <Image.Style>
                        <Style TargetType="Image">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsDownloading}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard x:Name="BounceStoryboard">
                                            <Storyboard>
                                                <!-- Drift X: slow side to side -->
                                                <DoubleAnimation
                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(TranslateTransform.X)"
                                                    From="-150" To="150"
                                                    Duration="0:0:4.5"
                                                    AutoReverse="True"
                                                    RepeatBehavior="Forever">
                                                    <DoubleAnimation.EasingFunction>
                                                        <SineEase EasingMode="EaseInOut" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>

                                                <!-- Hop Y: quick bounces -->
                                                <DoubleAnimationUsingKeyFrames
                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(TranslateTransform.Y)"
                                                    RepeatBehavior="Forever">
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0" Value="0" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.25" Value="-40">
                                                        <EasingDoubleKeyFrame.EasingFunction>
                                                            <QuadraticEase EasingMode="EaseOut" />
                                                        </EasingDoubleKeyFrame.EasingFunction>
                                                    </EasingDoubleKeyFrame>
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.5" Value="0">
                                                        <EasingDoubleKeyFrame.EasingFunction>
                                                            <BounceEase Bounces="1" Bounciness="4" EasingMode="EaseIn" />
                                                        </EasingDoubleKeyFrame.EasingFunction>
                                                    </EasingDoubleKeyFrame>
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.9" Value="0" />
                                                </DoubleAnimationUsingKeyFrames>

                                                <!-- Squash & stretch on hop -->
                                                <DoubleAnimationUsingKeyFrames
                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[1].(ScaleTransform.ScaleY)"
                                                    RepeatBehavior="Forever">
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0" Value="0.9" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.15" Value="1.1" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.5" Value="0.9" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.6" Value="1.0" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.9" Value="0.9" />
                                                </DoubleAnimationUsingKeyFrames>
                                                <DoubleAnimationUsingKeyFrames
                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[1].(ScaleTransform.ScaleX)"
                                                    RepeatBehavior="Forever">
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0" Value="1.05" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.15" Value="0.95" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.5" Value="1.05" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.6" Value="1.0" />
                                                    <EasingDoubleKeyFrame KeyTime="0:0:0.9" Value="1.05" />
                                                </DoubleAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <StopStoryboard BeginStoryboardName="BounceStoryboard" />
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Image.Style>
                </Image>

                <!-- Empty state (not downloading) -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding Downloads.Count}" Value="0" />
                                        <Condition Binding="{Binding IsDownloading}" Value="False" />
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible" />
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    <materialDesign:PackIcon
                        Kind="CloudDownloadOutline"
                        Width="48" Height="48"
                        HorizontalAlignment="Center"
                        Opacity="0.3" />
                    <TextBlock
                        Text="Enter a URL to start downloading"
                        HorizontalAlignment="Center"
                        Opacity="0.4"
                        Margin="0,12,0,0" />
                </StackPanel>

                <!-- Loading state (downloading, tracks not yet extracted) -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding Downloads.Count}" Value="0" />
                                        <Condition Binding="{Binding IsDownloading}" Value="True" />
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible" />
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    <ProgressBar
                        IsIndeterminate="True"
                        Width="200"
                        HorizontalAlignment="Center" />
                    <TextBlock
                        Text="Extracting tracks..."
                        HorizontalAlignment="Center"
                        Opacity="0.4"
                        Margin="0,12,0,0" />
                </StackPanel>

                <!-- Download items -->
                <ListBox
                    ItemsSource="{Binding Downloads}"
                    Style="{StaticResource MaterialDesignListBox}"
                    Background="Transparent"
                    VirtualizingStackPanel.IsVirtualizing="True"
                    VirtualizingStackPanel.ScrollUnit="Pixel"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:DownloadItemViewModel}">
                            <Grid Margin="8,6">
                                <Grid.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Open file"
                                                  Command="{Binding OpenFileCommand}"
                                                  IsEnabled="{Binding HasFile}">
                                            <MenuItem.Icon>
                                                <materialDesign:PackIcon Kind="FileMusic" />
                                            </MenuItem.Icon>
                                        </MenuItem>
                                        <MenuItem Header="Show in Explorer"
                                                  Command="{Binding ShowInExplorerCommand}"
                                                  IsEnabled="{Binding HasFile}">
                                            <MenuItem.Icon>
                                                <materialDesign:PackIcon Kind="FolderOpen" />
                                            </MenuItem.Icon>
                                        </MenuItem>
                                        <MenuItem Header="Retry"
                                                  Command="{Binding RetryCommand}"
                                                  IsEnabled="{Binding IsFailed}">
                                            <MenuItem.Icon>
                                                <materialDesign:PackIcon Kind="Refresh" />
                                            </MenuItem.Icon>
                                        </MenuItem>
                                    </ContextMenu>
                                </Grid.ContextMenu>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- Status icon -->
                                <materialDesign:PackIcon
                                    Grid.Column="0"
                                    Width="20" Height="20"
                                    VerticalAlignment="Center"
                                    Margin="0,0,12,0">
                                    <materialDesign:PackIcon.Style>
                                        <Style TargetType="materialDesign:PackIcon">
                                            <Setter Property="Kind" Value="MusicNote" />
                                            <Setter Property="Foreground" Value="{DynamicResource MaterialDesign.Brush.Foreground}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Status}" Value="Searching">
                                                    <Setter Property="Kind" Value="Magnify" />
                                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidBrush}" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Downloading">
                                                    <Setter Property="Kind" Value="Download" />
                                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidBrush}" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Completed">
                                                    <Setter Property="Kind" Value="CheckCircle" />
                                                    <Setter Property="Foreground" Value="LimeGreen" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Failed">
                                                    <Setter Property="Kind" Value="CloseCircle" />
                                                    <Setter Property="Foreground" Value="Tomato" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Cancelled">
                                                    <Setter Property="Kind" Value="Cancel" />
                                                    <Setter Property="Foreground" Value="Gray" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Skipped">
                                                    <Setter Property="Kind" Value="SkipNext" />
                                                    <Setter Property="Foreground" Value="Gray" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </materialDesign:PackIcon.Style>
                                </materialDesign:PackIcon>

                                <!-- Track name + detail + progress bar -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding TrackName}" FontSize="14" />
                                    <TextBlock Text="{Binding StatusDetail}" FontSize="11" Opacity="0.5"
                                               MinHeight="16" />
                                    <ProgressBar
                                        Value="{Binding ProgressPercent, Mode=OneWay}"
                                        Height="3"
                                        Margin="0,4,0,0"
                                        Opacity="{Binding IsActive, Converter={StaticResource BoolToOpacityConverter}}" />
                                </StackPanel>

                                <!-- Status text -->
                                <TextBlock
                                    Grid.Column="2"
                                    Text="{Binding StatusDisplay}"
                                    VerticalAlignment="Center"
                                    Opacity="0.7"
                                    Margin="12,0,0,0"
                                    MinWidth="70"
                                    TextAlignment="Right" />
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </materialDesign:Card>

        <!-- Row 3: Status Bar -->
        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal">
                <Button
                    Command="{Binding OpenDownloadFolderCommand}"
                    Style="{StaticResource MaterialDesignToolButton}"
                    ToolTip="Open download folder"
                    Padding="4" Height="28" Width="28"
                    Margin="0,0,4,0">
                    <materialDesign:PackIcon Kind="FolderOpen" Width="16" Height="16" Opacity="0.5" />
                </Button>
                <Button
                    Command="{Binding OpenLogFileCommand}"
                    Style="{StaticResource MaterialDesignToolButton}"
                    ToolTip="Open log file"
                    Padding="4" Height="28" Width="28"
                    Margin="0,0,8,0">
                    <materialDesign:PackIcon Kind="FileDocument" Width="16" Height="16" Opacity="0.5" />
                </Button>
            </StackPanel>

            <Button
                Grid.Column="1"
                Command="{Binding RetryFailedCommand}"
                Style="{StaticResource MaterialDesignFlatButton}"
                Content="Retry Failed"
                FontSize="12"
                Height="28"
                Padding="8,0"
                Margin="0,0,8,0"
                HorizontalAlignment="Left"
                Visibility="{Binding HasFailedDownloads, Converter={StaticResource BooleanToVisibilityConverter}}" />

            <TextBlock
                Grid.Column="2"
                Text="{Binding StatusText}"
                VerticalAlignment="Center"
                Opacity="0.6" />

            <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock VerticalAlignment="Center" Opacity="0.6" Margin="0,0,8,0">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0}/{1}">
                            <Binding Path="CompletedCount" />
                            <Binding Path="TotalCount" />
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
                <ProgressBar
                    Value="{Binding OverallProgress, Mode=OneWay}"
                    Width="120"
                    Height="6"
                    VerticalAlignment="Center" />
            </StackPanel>
        </Grid>
    </Grid>
</Window>
