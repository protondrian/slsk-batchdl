<Window x:Class="slsk_batchdl.Gui.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:vm="clr-namespace:slsk_batchdl.Gui.ViewModels"
        xmlns:converters="clr-namespace:slsk_batchdl.Gui.Converters"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance vm:MainViewModel}"
        Title="sldl"
        Height="650" Width="950"
        MinHeight="450" MinWidth="700"
        Style="{StaticResource MaterialDesignWindow}"
        Background="{DynamicResource MaterialDesign.Brush.Background}"
        TextElement.Foreground="{DynamicResource MaterialDesign.Brush.Foreground}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="14"
        FontFamily="{materialDesign:MaterialDesignFont}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        <converters:ZeroToVisibleConverter x:Key="ZeroToVisibleConverter" />
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Row 0: Search Input -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBox
                Grid.Column="0"
                Text="{Binding SearchInput, UpdateSourceTrigger=PropertyChanged}"
                materialDesign:HintAssist.Hint="Spotify/YouTube URL or search query..."
                materialDesign:HintAssist.IsFloating="False"
                materialDesign:TextFieldAssist.HasClearButton="True"
                Style="{StaticResource MaterialDesignOutlinedTextBox}"
                FontSize="16"
                Margin="0,0,12,0"
                VerticalContentAlignment="Center">
                <TextBox.InputBindings>
                    <KeyBinding Key="Return" Command="{Binding StartDownloadCommand}" />
                </TextBox.InputBindings>
            </TextBox>

            <!-- Start button (visible when not downloading) -->
            <Button
                Grid.Column="1"
                Command="{Binding StartDownloadCommand}"
                Style="{StaticResource MaterialDesignRaisedButton}"
                Height="48" Width="120"
                FontSize="15"
                Visibility="{Binding IsDownloading, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Play" VerticalAlignment="Center" Margin="0,0,6,0" />
                    <TextBlock Text="Start" VerticalAlignment="Center" />
                </StackPanel>
            </Button>

            <!-- Stop button (visible when downloading) -->
            <Button
                Grid.Column="1"
                Command="{Binding StopDownloadCommand}"
                Style="{StaticResource MaterialDesignRaisedButton}"
                Height="48" Width="120"
                FontSize="15"
                Visibility="{Binding IsDownloading, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Stop" VerticalAlignment="Center" Margin="0,0,6,0" />
                    <TextBlock Text="Stop" VerticalAlignment="Center" />
                </StackPanel>
            </Button>

            <Button
                Grid.Column="2"
                x:Name="SettingsButton"
                Click="SettingsButton_Click"
                Style="{StaticResource MaterialDesignIconButton}"
                ToolTip="Settings"
                Height="48" Width="48"
                Margin="4,0,0,0">
                <materialDesign:PackIcon Kind="Cog" Width="24" Height="24" />
            </Button>
        </Grid>

        <!-- Row 1: Quick Settings -->
        <materialDesign:Card Grid.Row="1" Margin="0,0,0,16" Padding="16"
                             materialDesign:ElevationAssist.Elevation="Dp1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Format -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,24,0">
                    <materialDesign:PackIcon Kind="MusicNote" VerticalAlignment="Center"
                                             Margin="0,0,8,0" Opacity="0.6" />
                    <ComboBox
                        ItemsSource="{Binding AvailableFormats}"
                        SelectedItem="{Binding SelectedFormat}"
                        materialDesign:HintAssist.Hint="Format"
                        materialDesign:HintAssist.IsFloating="True"
                        Style="{StaticResource MaterialDesignOutlinedComboBox}"
                        Width="100" />
                </StackPanel>

                <!-- Bitrate -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="0,0,24,0">
                    <materialDesign:PackIcon Kind="Equalizer" VerticalAlignment="Center"
                                             Margin="0,0,8,0" Opacity="0.6" />
                    <ComboBox
                        ItemsSource="{Binding AvailableBitrates}"
                        SelectedItem="{Binding PreferredBitrate}"
                        materialDesign:HintAssist.Hint="Min kbps"
                        materialDesign:HintAssist.IsFloating="True"
                        Style="{StaticResource MaterialDesignOutlinedComboBox}"
                        Width="100" />
                </StackPanel>

                <!-- Download Path -->
                <TextBox
                    Grid.Column="2"
                    Text="{Binding DownloadPath, UpdateSourceTrigger=PropertyChanged}"
                    materialDesign:HintAssist.Hint="Download path"
                    materialDesign:HintAssist.IsFloating="True"
                    Style="{StaticResource MaterialDesignOutlinedTextBox}"
                    VerticalContentAlignment="Center"
                    Margin="0,0,8,0" />

                <Button
                    Grid.Column="3"
                    Command="{Binding BrowseDownloadPathCommand}"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    Padding="8" Height="40">
                    <materialDesign:PackIcon Kind="FolderOpen" />
                </Button>
            </Grid>
        </materialDesign:Card>

        <!-- Row 2: Download List -->
        <materialDesign:Card Grid.Row="2" Margin="0,0,0,12"
                             materialDesign:ElevationAssist.Elevation="Dp1">
            <Grid>
                <!-- Empty state -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                            Visibility="{Binding Downloads.Count, Converter={StaticResource ZeroToVisibleConverter}}">
                    <materialDesign:PackIcon
                        Kind="CloudDownloadOutline"
                        Width="48" Height="48"
                        HorizontalAlignment="Center"
                        Opacity="0.3" />
                    <TextBlock
                        Text="Enter a URL or search query to start downloading"
                        HorizontalAlignment="Center"
                        Opacity="0.4"
                        Margin="0,12,0,0" />
                </StackPanel>

                <!-- Download items -->
                <ListBox
                    ItemsSource="{Binding Downloads}"
                    Style="{StaticResource MaterialDesignListBox}"
                    VirtualizingStackPanel.IsVirtualizing="True"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:DownloadItemViewModel}">
                            <Grid Margin="8,6">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- Status icon -->
                                <materialDesign:PackIcon
                                    Grid.Column="0"
                                    Width="20" Height="20"
                                    VerticalAlignment="Center"
                                    Margin="0,0,12,0">
                                    <materialDesign:PackIcon.Style>
                                        <Style TargetType="materialDesign:PackIcon">
                                            <Setter Property="Kind" Value="MusicNote" />
                                            <Setter Property="Foreground" Value="{DynamicResource MaterialDesign.Brush.Foreground}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Status}" Value="Searching">
                                                    <Setter Property="Kind" Value="Magnify" />
                                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidBrush}" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Downloading">
                                                    <Setter Property="Kind" Value="Download" />
                                                    <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidBrush}" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Completed">
                                                    <Setter Property="Kind" Value="CheckCircle" />
                                                    <Setter Property="Foreground" Value="LimeGreen" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Failed">
                                                    <Setter Property="Kind" Value="CloseCircle" />
                                                    <Setter Property="Foreground" Value="Tomato" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Skipped">
                                                    <Setter Property="Kind" Value="SkipNext" />
                                                    <Setter Property="Foreground" Value="Gray" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </materialDesign:PackIcon.Style>
                                </materialDesign:PackIcon>

                                <!-- Track name + progress bar -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding TrackName}" FontSize="14" />
                                    <ProgressBar
                                        Value="{Binding ProgressPercent, Mode=OneWay}"
                                        Height="3"
                                        Margin="0,4,0,0"
                                        Visibility="{Binding IsActive, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                </StackPanel>

                                <!-- Status text -->
                                <TextBlock
                                    Grid.Column="2"
                                    Text="{Binding StatusDisplay}"
                                    VerticalAlignment="Center"
                                    Opacity="0.7"
                                    Margin="12,0,0,0"
                                    MinWidth="70"
                                    TextAlignment="Right" />
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </materialDesign:Card>

        <!-- Row 3: Status Bar -->
        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock
                Grid.Column="0"
                Text="{Binding StatusText}"
                VerticalAlignment="Center"
                Opacity="0.6" />

            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock VerticalAlignment="Center" Opacity="0.6" Margin="0,0,8,0">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0}/{1}">
                            <Binding Path="CompletedCount" />
                            <Binding Path="TotalCount" />
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
                <ProgressBar
                    Value="{Binding OverallProgress, Mode=OneWay}"
                    Width="120"
                    Height="6"
                    VerticalAlignment="Center" />
            </StackPanel>
        </Grid>
    </Grid>
</Window>
